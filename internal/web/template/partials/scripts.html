{{define "scripts"}}
<script>
    const body = document.body;
    const navToggle = document.getElementById('nav-toggle');
    const modal = document.getElementById('cv-modal');

    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
        body.classList.add('is-safari');
    }

    const errorTranslations = {
        "error_cv_auth": "{{index .Content.Translations "error_cv_auth"}}",
        "error_cv_expired": "{{index .Content.Translations "error_cv_expired"}}",
        "error_cv_not_found": "{{index .Content.Translations "error_cv_not_found"}}",
        "error_cv_server": "{{index .Content.Translations "error_cv_server"}}",
        "error_message": "{{index .Content.Translations "error_message"}}"
    };

    const fallbackMessages = {
        "pl": "Wystąpił nieoczekiwany błąd. Spróbuj ponownie.",
        "en": "An unexpected error occurred. Please try again."
    };

    const toggleScroll = () => {
        const isLocked = (navToggle && navToggle.checked) || (modal && modal.classList.contains('open'));
        if (isLocked) {
            body.classList.add('no-scroll');
        } else {
            body.classList.remove('no-scroll');
        }
    };

    const forceReset = () => {
        body.classList.add('no-transition');
        if (navToggle) navToggle.checked = false;
        toggleScroll();
        void body.offsetHeight;
        setTimeout(() => {
            body.classList.remove('no-transition');
        }, 50);
    };

    if (navToggle) navToggle.addEventListener('change', toggleScroll);

    window.addEventListener('pageshow', forceReset);
    window.addEventListener('popstate', forceReset);
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            forceReset();
        }
    });

    document.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;

        const href = link.getAttribute('href');

        if (href && href.startsWith('#')) {
            e.preventDefault();

            if (navToggle && navToggle.checked) {
                navToggle.checked = false;
                toggleScroll();
            }

            const targetId = href.substring(1);
            const targetElement = targetId === 'top' ? body : document.getElementById(targetId);

            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }, 50);
            }
            return;
        }

        if (href && (link.getAttribute('target') === '_blank' || link.classList.contains('cv-link'))) {
            setTimeout(forceReset, 10);
        }
    });

    const backToTopButton = document.querySelector('.back-to-top');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 100) {
            backToTopButton.classList.add('visible');
        } else {
            backToTopButton.classList.remove('visible');
        }
    });

    const cvForm = document.getElementById('cv-form');
    if (cvForm) {
        const submitBtn = modal.querySelector('.modal-btn');
        const errorMsg = document.getElementById('modal-error');
        const passInput = document.getElementById('cv-password');
        const hpInput = document.getElementById('cv-hp-name');

        document.querySelectorAll('.cv-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                forceReset();
                modal.classList.add('open');
                toggleScroll();
                errorMsg.style.display = 'none';
                errorMsg.textContent = '';
                passInput.value = '';
                passInput.focus();
            };
        });

        document.querySelector('.modal-close').onclick = () => {
            modal.classList.remove('open');
            toggleScroll();
        };

        window.onclick = (e) => {
            if (e.target === modal) {
                modal.classList.remove('open');
                toggleScroll();
            }
        };

        cvForm.onsubmit = async (e) => {
            e.preventDefault();

            if (hpInput.value !== "") {
                return;
            }

            const pass = passInput.value;
            const lang = document.documentElement.lang || 'pl';

            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            errorMsg.style.display = 'none';
            errorMsg.textContent = '';

            try {
                const res = await fetch(`/api/cv-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: pass,
                        lang: lang,
                        fullName: hpInput.value
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    const slug = data.error || 'error_cv_server';
                    let message = errorTranslations[slug];

                    if (!message || message === "") {
                        message = fallbackMessages[lang] || fallbackMessages['en'];
                    }

                    throw new Error(message);
                }

                if (!data.token) throw new Error(fallbackMessages[lang] || fallbackMessages['en']);

                if (data.token === "token") {
                    modal.classList.remove('open');
                    toggleScroll();
                    return;
                }

                const proxyUrl = `/api/download/cv?token=${data.token}&lang=${lang}`;
                const isMobile = window.matchMedia("(max-width: 768px)").matches || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

                if (isMobile) {
                    window.location.href = proxyUrl;
                } else {
                    window.open(proxyUrl, '_blank');
                }

                modal.classList.remove('open');
                toggleScroll();

            } catch (err) {
                errorMsg.textContent = err.message;
                errorMsg.style.display = 'block';
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        };
    }
</script>
{{end}}